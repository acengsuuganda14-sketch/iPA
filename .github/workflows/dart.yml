name: iOS-ipa-build

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: ðŸŽ‰ Build iOS and Upload IPA
    runs-on: macos-latest

    steps:
      # 1. Checkout repo
      - uses: actions/checkout@v3

      # 2. Setup Flutter
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      # 3. Install dependencies
      - name: Get Flutter packages
        run: flutter pub get
        working-directory: .

      # 4. Update CocoaPods
      - name: Update CocoaPods
        run: pod repo update
        working-directory: ios

      # 5. Build iOS app (release, no codesign)
      - name: Build iOS app
        run: flutter build ios --release --no-codesign
        working-directory: .

      # 6. Siapkan Payload untuk IPA
      - name: Prepare Payload folder
        run: |
          mkdir -p build/ios/iphoneos/Payload
          mv build/ios/iphoneos/Runner.app build/ios/iphoneos/Payload/

      # 7. Buat file IPA
      - name: Zip output into IPA
        run: zip -qq -r -9 FlutterIpaExport.ipa Payload
        working-directory: build/ios/iphoneos

      # 8. Pastikan tag v1.0 ada
      - name: Ensure tag exists
        run: |
          git fetch --tags
          if ! git rev-parse "v1.0" >/dev/null 2>&1; then
            git tag v1.0
            git push origin v1.0

      # 9. Upload ke GitHub Release menggunakan token otomatis
      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/ios/iphoneos/FlutterIpaExport.ipa
          tag: v1.0
          overwrite: true
          body: "This is first release"
