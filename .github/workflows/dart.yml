name: ğŸš€ iOS IPA Build & Release

on:
  workflow_dispatch:
    inputs:
      release-version:
        description: 'Release Version (format: v1.0.0)'
        required: true
        default: 'v1.0.0'
      build-type:
        description: 'Build Type'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - profile

env:
  FLUTTER_CHANNEL: stable
  BUILD_TYPE: release

jobs:
  build-ios:
    name: ğŸ“± Build iOS IPA
    runs-on: macos-latest
    
    steps:
      # 1. Checkout repository dengan depth lengkap
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Setup Flutter dengan caching
      - name: âš™ï¸ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          architecture: x64
          cache: true
          cache-key: flutter-${{ env.FLUTTER_CHANNEL }}-${{ hashFiles('pubspec.lock') }}
          cache-path: ${{ runner.tool_cache }}/flutter

      # 3. Validate Flutter installation
      - name: ğŸ”§ Validate Flutter
        run: |
          flutter --version
          flutter doctor -v
          which pod

      # 4. Install dependencies dengan error handling
      - name: ğŸ“¦ Install Dependencies
        run: |
          set -e
          flutter pub get
          flutter pub deps --style=compact
        working-directory: .

      # 5. Setup iOS dependencies
      - name: ğŸ Setup iOS Dependencies
        run: |
          set -e
          pod repo update
          pod install --clean-install --repo-update
        working-directory: ios

      # 6. Clean build directory
      - name: ğŸ§¹ Clean Previous Builds
        run: |
          flutter clean
          rm -rf build/ios
          rm -rf *.ipa || true

      # 7. Build iOS dengan error handling
      - name: ğŸ”¨ Build iOS App
        run: |
          set -e
          echo "Building iOS ${{ env.BUILD_TYPE }} version..."
          flutter build ios --${{ env.BUILD_TYPE }} --no-codesign --verbose
          
          # Verify build output
          if [ ! -d "build/ios/iphoneos/Runner.app" ]; then
            echo "âŒ Build failed: Runner.app not found"
            exit 1
          fi
          
          echo "âœ… Build completed successfully"

      # 8. Extract version from pubspec.yaml
      - name: ğŸ·ï¸ Extract Version Info
        id: version
        run: |
          set -e
          VERSION=$(grep 'version:' pubspec.yaml | head -1 | awk -F' ' '{print $2}' | tr -d '\r')
          APP_NAME=$(grep 'name:' pubspec.yaml | head -1 | awk -F' ' '{print $2}' | tr -d '\r')
          
          echo "Extracted version: $VERSION"
          echo "App name: $APP_NAME"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          
          # Write to environment file for subsequent steps
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV

      # 9. Create IPA package
      - name: ğŸ“¦ Create IPA Package
        id: package_ipa
        run: |
          set -e
          cd build/ios/iphoneos
          
          # Create Payload directory
          mkdir -p Payload
          
          # Move app to Payload
          cp -r Runner.app Payload/
          
          # Create IPA with timestamp
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          IPA_NAME="${{ env.APP_NAME }}_${{ env.APP_VERSION }}_$TIMESTAMP.ipa"
          
          zip -qr "$IPA_NAME" Payload
          
          # Move IPA to root directory
          mv "$IPA_NAME" ../../../
          
          # Set output
          echo "ipa_name=$IPA_NAME" >> $GITHUB_OUTPUT
          echo "ipa_path=$GITHUB_WORKSPACE/$IPA_NAME" >> $GITHUB_OUTPUT
          
          echo "âœ… IPA created: $IPA_NAME"
          
          # Verify IPA file
          if [ ! -f "../../../$IPA_NAME" ]; then
            echo "âŒ IPA creation failed"
            exit 1
          fi

      # 10. Create Git tag
      - name: ğŸ·ï¸ Create Git Tag
        id: create_tag
        run: |
          set -e
          TAG_NAME="${{ inputs.release-version }}"
          
          # Check if tag already exists
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "âš ï¸ Tag $TAG_NAME already exists. Deleting and recreating..."
            git tag -d "$TAG_NAME" || true
            git push --delete origin "$TAG_NAME" || true
          fi
          
          # Create new tag
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME - Built on $(date)"
          git push origin "$TAG_NAME"
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "âœ… Tag $TAG_NAME created and pushed"

      # 11. Create GitHub Release
      - name: ğŸš€ Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.create_tag.outputs.tag_name }}
          release_name: "Release ${{ steps.create_tag.outputs.tag_name }} - ${{ env.APP_NAME }}"
          body: |
            ğŸš€ **${{ env.APP_NAME }} v${{ env.APP_VERSION }}**
            
            **Build Information:**
            - **Version:** ${{ env.APP_VERSION }}
            - **Build Type:** ${{ env.BUILD_TYPE }}
            - **Flutter Channel:** ${{ env.FLUTTER_CHANNEL }}
            - **Build Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            **Installation:**
            - Download the .ipa file
            - Install using tools like AltStore, Cydia Impactor, or Apple Configurator
            
            **Notes:**
            This is an unsigned IPA for testing purposes.
          draft: false
          prerelease: false
          files: |
            ${{ steps.package_ipa.outputs.ipa_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 12. Upload IPA as artifact (backup)
      - name: ğŸ’¾ Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa-${{ steps.create_tag.outputs.tag_name }}
          path: ${{ steps.package_ipa.outputs.ipa_path }}
          retention-days: 30

  # Optional: Notify success
  notify:
    name: ğŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: build-ios
    if: always()
    
    steps:
      - name: âœ… Build Status
        run: |
          if [ "${{ needs.build-ios.result }}" == "success" ]; then
            echo "ğŸ‰ Build successful! IPA uploaded to Release: ${{ needs.build-ios.outputs.tag_name }}"
            echo "ğŸ“± Download URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.build-ios.outputs.tag_name }}"
          else
            echo "âŒ Build failed! Check the logs for details."
            exit 1
          fi
